# Requires -Version 7.0
$ErrorActionPreference = "Stop"
# This makes native commands (git) throw exceptions on failure, acting like 'set -e'
$PSNativeCommandUseErrorActionPreference = $true

# --- Configuration ---
# Check if OriginUrl is provided (e.g. via environment variable or parameter context)
# If not, prompt the user interactively.
if ([string]::IsNullOrWhiteSpace($OriginUrl)) {
    Write-Host "Don't have a fork yet? https://github.com/flutter/flutter/fork" -ForegroundColor Cyan
    Write-Host "Please enter your Flutter fork URL (e.g. git@github.com:username/flutter.git)" -ForegroundColor Cyan
    $OriginUrl = Read-Host "Origin URL"
}

if ([string]::IsNullOrWhiteSpace($OriginUrl)) {
    Write-Error "âŒ Error: Origin URL is required. Aborting."
    exit 1
}

$UpstreamUrl   = "https://github.com/flutter/flutter.git"

# Specific refs
$RefStable = "stable"

Write-Host "ðŸš€ Starting Flutter Worktree Setup (PS 7.5)..." -ForegroundColor Cyan

# 1. Create root directory
if (Test-Path -Path flutter -PathType Container) {
    Write-Error "âŒ Error: Directory 'flutter' already exists. Aborting."
    exit 1
}
New-Item -ItemType Directory -Path flutter
Set-Location flutter
$RootPath = Get-Location

# 2. Clone Bare Repo
Write-Host "ðŸ“¦ Cloning origin as bare repository..." -ForegroundColor Yellow
git clone --bare "$OriginUrl" .bare

# Create .git pointer (Ascii is safest for git, though PS7 UTF8NoBOM works too)
Set-Content -Path .git -Value "gitdir: ./.bare" -Encoding Ascii

# 3. Configure Remotes
Set-Location .bare
Write-Host "âš™ï¸  Configuring remotes..." -ForegroundColor Yellow

# Fix Origin and Add Upstream
git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"
git remote add upstream "$UpstreamUrl"
git config remote.upstream.fetch "+refs/heads/*:refs/remotes/upstream/*"

# 4. Fetch All
Write-Host "â¬‡ï¸  Fetching everything (--all --tags --prune)..." -ForegroundColor Yellow
git fetch --all --tags --prune

# 5. Create Worktrees
Set-Location ..

# --- Setup MASTER ---
Write-Host "ðŸŒ² Creating 'master' worktree..." -ForegroundColor Green

# Use a try-catch block for more idiomatic error handling.
try {
    git branch -D master 2>$null
}
catch {
    Write-Host "   (No existing master branch to delete, continuing...)" -ForegroundColor DarkGray
}

# Create new master worktree tracking upstream
git worktree add -B master master --track upstream/master

# --- Setup STABLE ---
$setupStable = Read-Host "Do you want to setup the 'stable' worktree? (y/N)"
if ($setupStable -match "^[yY]") {
    Write-Host "ðŸŒ² Creating 'stable' worktree (based on upstream/$RefStable)..." -ForegroundColor Green
    git worktree add -B stable stable --track upstream/"$RefStable"
}

# 6. Pre-load Artifacts
# Determine correct flutter command based on OS for cross-platform compatibility
$flutterCmd = if ($IsWindows) { ".\bin\flutter.bat" } else { "./bin/flutter" }
if ($setupStable -match "^[yY]") {
    Write-Host "ðŸ› ï¸  Hydrating 'stable' artifacts..." -ForegroundColor Magenta
    Set-Location stable
    & $flutterCmd --version | Out-Null
    Set-Location ..
}

Write-Host "ðŸ› ï¸  Hydrating 'master' artifacts..." -ForegroundColor Magenta
Set-Location master
& $flutterCmd --version | Out-Null
Set-Location ..

# 7. Generate The Switcher Script
Write-Host "ðŸ”— Generating context switcher..." -ForegroundColor Cyan
$SwitchFile = Join-Path $RootPath "fswitch.ps1"

$PAYLOAD = "IyBTb3VyY2UgdGhpcyBmaWxlIGluIHlvdXIgUG93ZXJTaGVsbCBQcm9maWxlDQojIFVzYWdlOiAuICIkU3dpdGNoRmlsZSINCg0KIyBSZXNldCByb290IHRvIGVuc3VyZSBubyBzdGFsZSB2YWx1ZXMNCiRnbG9iYWw6Rmx1dHRlclJlcG9Sb290ID0gJG51bGwNCg0KaWYgKCRQU1NjcmlwdFJvb3QpIHsNCiAgICAkZ2xvYmFsOkZsdXR0ZXJSZXBvUm9vdCA9ICRQU1NjcmlwdFJvb3QNCn0NCmVsc2Ugew0KICAgICRnbG9iYWw6Rmx1dHRlclJlcG9Sb290ID0gR2V0LUxvY2F0aW9uIHwgU2VsZWN0LU9iamVjdCAtRXhwYW5kUHJvcGVydHkgUGF0aA0KfQ0KDQpmdW5jdGlvbiBHZXQtRmx1dHRlcldvcmt0cmVlcyB7DQogICAgaWYgKFRlc3QtUGF0aCAiJGdsb2JhbDpGbHV0dGVyUmVwb1Jvb3QiIC1QYXRoVHlwZSBDb250YWluZXIpIHsNCiAgICAgICAgJGdpdEFyZ3MgPSBAKCItQyIsICIkZ2xvYmFsOkZsdXR0ZXJSZXBvUm9vdCIsICJ3b3JrdHJlZSIsICJsaXN0IikNCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgICRvdXRwdXQgPSAmIGdpdCAkZ2l0QXJncyAyPiRudWxsDQogICAgICAgICAgICBpZiAoJExBU1RFWElUQ09ERSAtZXEgMCkgew0KICAgICAgICAgICAgICAgICRvdXRwdXQgfCBXaGVyZS1PYmplY3QgeyAkXyAtbm90bWF0Y2ggIlwoYmFyZVwpIiB9IHwgRm9yRWFjaC1PYmplY3Qgew0KICAgICAgICAgICAgICAgICAgICBpZiAoJF8gLW1hdGNoICdeKD88cGF0aD4uKj8pXHMrWzAtOWEtZl0rXHMrKD88ZXh0cmE+LiopJCcpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICRmdWxsUGF0aCA9ICRtYXRjaGVzWydwYXRoJ10NCiAgICAgICAgICAgICAgICAgICAgICAgICRleHRyYSA9ICRtYXRjaGVzWydleHRyYSddDQogICAgICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgICAgICMgQ2FsY3VsYXRlIERpck5hbWUgKFJlbGF0aXZlIHBhdGggb3IgTGVhZiBuYW1lKQ0KICAgICAgICAgICAgICAgICAgICAgICAgJGRpck5hbWUgPSAiIg0KICAgICAgICAgICAgICAgICAgICAgICAgIyBOb3JtYWxpemUgZm9yIGNvbXBhcmlzb24gKEdpdCBvdXRwdXQgdXN1YWxseSBoYXMgZm9yd2FyZCBzbGFzaGVzIG9yIG1hdGNoZXMgc3lzdGVtKQ0KICAgICAgICAgICAgICAgICAgICAgICAgIyBXZSB1c2Ugc2ltcGxlIHN0cmluZyBvcGVyYXRpb25zLiANCiAgICAgICAgICAgICAgICAgICAgICAgICMgQXNzdW1pbmcgJGdsb2JhbDpGbHV0dGVyUmVwb1Jvb3QgaXMgbm9ybWFsaXplZCB0byBzeXN0ZW0gc2VwYXJhdG9ycyBieSBQU1NjcmlwdFJvb3QgbG9naWMgdXN1YWxseT8NCiAgICAgICAgICAgICAgICAgICAgICAgICMgQnV0IGdpdCBvdXRwdXQgbWlnaHQgdXNlIGZvcndhcmQgc2xhc2hlcyBldmVuIG9uIFdpbmRvd3MuDQogICAgICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgICAgICRub3JtRnVsbCA9ICRmdWxsUGF0aCAtcmVwbGFjZSAnW1xcL10nLCBbU3lzdGVtLklPLlBhdGhdOjpEaXJlY3RvcnlTZXBhcmF0b3JDaGFyDQogICAgICAgICAgICAgICAgICAgICAgICAkbm9ybVJvb3QgPSAkZ2xvYmFsOkZsdXR0ZXJSZXBvUm9vdCAtcmVwbGFjZSAnW1xcL10nLCBbU3lzdGVtLklPLlBhdGhdOjpEaXJlY3RvcnlTZXBhcmF0b3JDaGFyDQogICAgICAgICAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkbm9ybUZ1bGwgLWVxICRub3JtUm9vdCkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICRkaXJOYW1lID0gU3BsaXQtUGF0aCAtTGVhZiAkbm9ybUZ1bGwNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2VpZiAoJG5vcm1GdWxsLlN0YXJ0c1dpdGgoJG5vcm1Sb290LCBbU3lzdGVtLlN0cmluZ0NvbXBhcmlzb25dOjpPcmRpbmFsSWdub3JlQ2FzZSkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIFJlbW92ZSByb290IHByZWZpeCBhbmQgbGVhZGluZyBzbGFzaA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICRkaXJOYW1lID0gJG5vcm1GdWxsLlN1YnN0cmluZygkbm9ybVJvb3QuTGVuZ3RoKS5UcmltU3RhcnQoW1N5c3RlbS5JTy5QYXRoXTo6RGlyZWN0b3J5U2VwYXJhdG9yQ2hhcikNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgRmFsbGJhY2sNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZGlyTmFtZSA9IFNwbGl0LVBhdGggLUxlYWYgJG5vcm1GdWxsDQogICAgICAgICAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAgICAgICAgICRicmFuY2ggPSAiIg0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRleHRyYSAtbWF0Y2ggJ1xbKD88YnI+Lio/KVxdJykgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICRicmFuY2ggPSAkbWF0Y2hlc1snYnInXQ0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgICAgICAgICBbUFNDdXN0b21PYmplY3RdQHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBQYXRoICAgID0gJG5vcm1GdWxsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgRGlyTmFtZSA9ICRkaXJOYW1lDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgQnJhbmNoICA9ICRicmFuY2gNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBjYXRjaCB7DQogICAgICAgICAgICBXcml0ZS1XYXJuaW5nICJDb3VsZCBub3QgZXhlY3V0ZSAnZ2l0IHdvcmt0cmVlIGxpc3QnLiBFbnN1cmUgZ2l0IGlzIGluc3RhbGxlZCBhbmQgaW4geW91ciBQQVRILiINCiAgICAgICAgfQ0KICAgIH0NCn0NCg0KZnVuY3Rpb24gZnN3aXRjaCB7DQogICAgcGFyYW0oDQogICAgICAgIFtQYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJHRydWUsIFBvc2l0aW9uID0gMCldDQogICAgICAgIFtBcmd1bWVudENvbXBsZXRlcih7DQogICAgICAgICAgICAgICAgcGFyYW0oJGNvbW1hbmROYW1lLCAkcGFyYW1ldGVyTmFtZSwgJHdvcmRUb0NvbXBsZXRlLCAkY29tbWFuZEFzdCwgJGZha2VCb3VuZFBhcmFtZXRlcnMpDQogICAgICAgICAgICAgICAgJHdvcmt0cmVlcyA9IEdldC1GbHV0dGVyV29ya3RyZWVzDQogICAgICAgICAgICAgICAgJHRhcmdldHMgPSBAKCkNCiAgICAgICAgICAgICAgICBpZiAoJHdvcmt0cmVlcykgew0KICAgICAgICAgICAgICAgICAgICAkdGFyZ2V0cyArPSAkd29ya3RyZWVzLkRpck5hbWUNCiAgICAgICAgICAgICAgICAgICAgJHRhcmdldHMgKz0gJHdvcmt0cmVlcy5CcmFuY2gNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgJHRhcmdldHMgfCBXaGVyZS1PYmplY3QgeyAkXyAtbGlrZSAiJHdvcmRUb0NvbXBsZXRlKiIgfSB8IFNvcnQtT2JqZWN0IC1VbmlxdWUgfCBGb3JFYWNoLU9iamVjdCB7DQogICAgICAgICAgICAgICAgICAgIFtTeXN0ZW0uTWFuYWdlbWVudC5BdXRvbWF0aW9uLkNvbXBsZXRpb25SZXN1bHRdOjpuZXcoJF8sICRfLCAnUGFyYW1ldGVyVmFsdWUnLCAkXykNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9KV0NCiAgICAgICAgW3N0cmluZ10kVGFyZ2V0DQogICAgKQ0KDQogICAgJHdvcmt0cmVlcyA9IEdldC1GbHV0dGVyV29ya3RyZWVzDQogICAgJHJlc29sdmVkV3QgPSAkbnVsbA0KDQogICAgaWYgKCR3b3JrdHJlZXMpIHsNCiAgICAgICAgZm9yZWFjaCAoJHd0IGluICR3b3JrdHJlZXMpIHsNCiAgICAgICAgICAgIGlmICgkVGFyZ2V0IC1lcSAkd3QuRGlyTmFtZSAtb3IgKCR3dC5CcmFuY2ggLWFuZCAkVGFyZ2V0IC1lcSAkd3QuQnJhbmNoKSkgew0KICAgICAgICAgICAgICAgICRyZXNvbHZlZFd0ID0gJHd0DQogICAgICAgICAgICAgICAgYnJlYWsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIGlmICgkbnVsbCAtZXEgJHJlc29sdmVkV3QpIHsNCiAgICAgICAgV3JpdGUtRXJyb3IgIuKdjCBJbnZhbGlkIHRhcmdldDogJyRUYXJnZXQnIg0KICAgICAgICBXcml0ZS1Ib3N0ICIgICBBdmFpbGFibGUgY29udGV4dHM6Ig0KICAgICAgICBpZiAoJHdvcmt0cmVlcykgew0KICAgICAgICAgICAgZm9yZWFjaCAoJHd0IGluICR3b3JrdHJlZXMpIHsNCiAgICAgICAgICAgICAgICAkYkluZm8gPSBpZiAoJHd0LkJyYW5jaCkgeyAkd3QuQnJhbmNoIH0gZWxzZSB7ICJkZXRhY2hlZCIgfQ0KICAgICAgICAgICAgICAgIFdyaXRlLUhvc3QgIiAgIC0gJCgkd3QuRGlyTmFtZSkgKCRiSW5mbykiDQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgZWxzZSB7DQogICAgICAgICAgICBXcml0ZS1Ib3N0ICIgICAoTm8gd29ya3RyZWVzIGZvdW5kLiBDaGVjayBpZiBnaXQgaXMgaW5zdGFsbGVkIGFuZCAnJGdsb2JhbDpGbHV0dGVyUmVwb1Jvb3QnIGlzIGEgdmFsaWQgcmVwby4pIg0KICAgICAgICB9DQogICAgICAgIHJldHVybg0KICAgIH0NCg0KICAgICMgMS4gQ2xlYW4gUGF0aA0KICAgIGlmICgkSXNXaW5kb3dzKSB7DQogICAgICAgICRzZXBDaGFyID0gJzsnDQogICAgfQ0KICAgIGVsc2Ugew0KICAgICAgICAkc2VwQ2hhciA9ICc6Jw0KICAgIH0NCg0KICAgIGlmICgkbnVsbCAtbmUgJGVudjpQQVRIKSB7DQogICAgICAgICRjdXJyZW50UGF0aCA9ICRlbnY6UEFUSC5TcGxpdCgkc2VwQ2hhciwgW1N5c3RlbS5TdHJpbmdTcGxpdE9wdGlvbnNdOjpSZW1vdmVFbXB0eUVudHJpZXMpDQogICAgfQ0KICAgIGVsc2Ugew0KICAgICAgICAkY3VycmVudFBhdGggPSBAKCkNCiAgICB9DQoNCiAgICAkY2xlYW5QYXRoID0gQCgkY3VycmVudFBhdGgpIHwgV2hlcmUtT2JqZWN0IHsNCiAgICAgICAgJHBhdGggPSAkXw0KICAgICAgICBpZiAoW3N0cmluZ106OklzTnVsbE9yV2hpdGVTcGFjZSgkcGF0aCkpIHsNCiAgICAgICAgICAgIHJldHVybiAkZmFsc2UNCiAgICAgICAgfQ0KDQogICAgICAgIGlmICgtbm90IFtzdHJpbmddOjpJc051bGxPckVtcHR5KCRnbG9iYWw6Rmx1dHRlclJlcG9Sb290KSkgew0KICAgICAgICAgICAgJG5vcm1QYXRoID0gJHBhdGguVHJpbUVuZChbU3lzdGVtLklPLlBhdGhdOjpEaXJlY3RvcnlTZXBhcmF0b3JDaGFyLCBbU3lzdGVtLklPLlBhdGhdOjpBbHREaXJlY3RvcnlTZXBhcmF0b3JDaGFyKQ0KICAgICAgICAgICAgJG5vcm1Sb290ID0gJGdsb2JhbDpGbHV0dGVyUmVwb1Jvb3QuVHJpbUVuZChbU3lzdGVtLklPLlBhdGhdOjpEaXJlY3RvcnlTZXBhcmF0b3JDaGFyLCBbU3lzdGVtLklPLlBhdGhdOjpBbHREaXJlY3RvcnlTZXBhcmF0b3JDaGFyKQ0KICAgICAgICAgICAgaWYgKCRub3JtUGF0aC5TdGFydHNXaXRoKCRub3JtUm9vdCkpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gJGZhbHNlDQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuICR0cnVlDQogICAgfQ0KDQogICAgIyAyLiBVcGRhdGUgUGF0aA0KICAgICMgVXNlIHRoZSBGVUxMIFBBVEggZnJvbSB0aGUgcmVzb2x2ZWQgd29ya3RyZWUNCiAgICAkbmV3QmluID0gSm9pbi1QYXRoICRyZXNvbHZlZFd0LlBhdGggImJpbiINCg0KICAgIGlmICgtbm90IChUZXN0LVBhdGggJG5ld0JpbiAtUGF0aFR5cGUgQ29udGFpbmVyKSkgew0KICAgICAgICBXcml0ZS1FcnJvciAi4p2MIEVycm9yOiBGbHV0dGVyIGJpbiBkaXJlY3Rvcnkgbm90IGZvdW5kIGF0ICckbmV3QmluJyINCiAgICAgICAgcmV0dXJuDQogICAgfQ0KDQogICAgaWYgKC1ub3QgJElzV2luZG93cykgew0KICAgICAgICAkZmx1dHRlckJpbiA9IEpvaW4tUGF0aCAkbmV3QmluICJmbHV0dGVyIg0KICAgICAgICBpZiAoVGVzdC1QYXRoICRmbHV0dGVyQmluKSB7DQogICAgICAgICAgICBpZiAoR2V0LUNvbW1hbmQgY2htb2QgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUpIHsNCiAgICAgICAgICAgICAgICBjaG1vZCAreCAiJGZsdXR0ZXJCaW4iIDI+JG51bGwNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIGlmICgkY2xlYW5QYXRoLkNvdW50IC1ndCAwKSB7DQogICAgICAgICRlbnY6UEFUSCA9ICIkbmV3QmluJHNlcENoYXIiICsgKCRjbGVhblBhdGggLWpvaW4gJHNlcENoYXIpDQogICAgfQ0KICAgIGVsc2Ugew0KICAgICAgICAkZW52OlBBVEggPSAiJG5ld0JpbiINCiAgICB9DQoNCiAgICAjIDMuIFZlcmlmeQ0KICAgIFdyaXRlLUhvc3QgIuKchSBTd2l0Y2hlZCB0byBGbHV0dGVyICQoJHJlc29sdmVkV3QuRGlyTmFtZSkiIC1Gb3JlZ3JvdW5kQ29sb3IgR3JlZW4NCg0KICAgICRmbHV0dGVyUGF0aCA9IChHZXQtQ29tbWFuZCBmbHV0dGVyIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlKS5Tb3VyY2UNCiAgICAkZGFydFBhdGggPSAoR2V0LUNvbW1hbmQgZGFydCAtRXJyb3JBY3Rpb24gU2lsZW50bHlDb250aW51ZSkuU291cmNlDQoNCiAgICBXcml0ZS1Ib3N0ICIgICBGbHV0dGVyOiAkZmx1dHRlclBhdGgiDQogICAgV3JpdGUtSG9zdCAiICAgRGFydDogICAgJGRhcnRQYXRoIg0KfQ0KDQojIE9wdGlvbmFsOiBEZWZhdWx0IHRvIGEgdmVyc2lvbiBvbiBsb2FkIGlmIG5vIGZsdXR0ZXIgaXMgZm91bmQNCmlmICgtbm90IChHZXQtQ29tbWFuZCBmbHV0dGVyIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlKSkgew0KICAgICMgU3dpdGNoIHRvIG1hc3Rlcg0KICAgIGZzd2l0Y2ggbWFzdGVyDQp9DQo="
[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($PAYLOAD)) | Set-Content -Path $SwitchFile -Encoding UTF8

Write-Host ""
Write-Host "âœ… Setup Complete!" -ForegroundColor Green
Write-Host "------------------------------------------------------"
Write-Host "ðŸ“‚ Root:      $RootPath"
Write-Host "ðŸ‘‰ To enable the switcher, add this to your PowerShell Profile:"
Write-Host "   . '$SwitchFile'"
Write-Host ""
Write-Host "Usage:"
Write-Host "   PS> fswitch master   -> Activates master branch"
Write-Host "   PS> fswitch stable   -> Activates stable branch"
Write-Host ""
Write-Host "Want to create a new worktree?"
Write-Host "   PS> git worktree add my_feature"
Write-Host "------------------------------------------------------"
