# Requires -Version 7.0
$ErrorActionPreference = "Stop"
# This makes native commands (git) throw exceptions on failure, acting like 'set -e'
$PSNativeCommandUseErrorActionPreference = $true

# --- Configuration ---
# Check if OriginUrl is provided (e.g. via environment variable or parameter context)
# If not, prompt the user interactively.
if ([string]::IsNullOrWhiteSpace($OriginUrl)) {
    if (-not [string]::IsNullOrWhiteSpace($env:ORIGIN_URL)) {
        $OriginUrl = $env:ORIGIN_URL.Trim()
    }
    else {
        Write-Host "Don't have a fork yet? https://github.com/flutter/flutter/fork" -ForegroundColor Cyan
        Write-Host "Please enter your Flutter fork URL (e.g. git@github.com:username/flutter.git)" -ForegroundColor Cyan
        $OriginUrl = Read-Host "Origin URL"
    }
}

if ([string]::IsNullOrWhiteSpace($OriginUrl)) {
    Write-Error "âŒ Error: Origin URL is required. Aborting."
    exit 1
}

$UpstreamUrl = "https://github.com/flutter/flutter.git"

# Specific refs
$RefStable = "stable"

Write-Host "ðŸš€ Starting Flutter Worktree Setup (PS 7.5)..." -ForegroundColor Cyan

# 1. Create root directory
if (Test-Path -Path flutter -PathType Container) {
    Write-Error "âŒ Error: Directory 'flutter' already exists. Aborting."
    exit 1
}
New-Item -ItemType Directory -Path flutter
Set-Location flutter
$RootPath = Get-Location

# 2. Clone Bare Repo
Write-Host "ðŸ“¦ Cloning origin as bare repository..." -ForegroundColor Yellow
Write-Host "   Origin: '$OriginUrl'" -ForegroundColor DarkGray
git clone --bare "$OriginUrl" .bare

# Create .git pointer (Ascii is safest for git, though PS7 UTF8NoBOM works too)
Set-Content -Path .git -Value "gitdir: ./.bare" -Encoding Ascii

# 3. Configure Remotes
Write-Host "âš™ï¸  Configuring remotes..." -ForegroundColor Yellow

# Fix Origin and Add Upstream
git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"
git remote add upstream "$UpstreamUrl"
git config remote.upstream.fetch "+refs/heads/*:refs/remotes/upstream/*"

# 4. Fetch All
Write-Host "â¬‡ï¸  Fetching everything (--all --tags --prune)..." -ForegroundColor Yellow
git fetch --all --tags --prune

# --- Setup MASTER ---
Write-Host "ðŸŒ² Creating 'master' worktree..." -ForegroundColor Green

# Use a try-catch block for more idiomatic error handling.
try {
    git branch -D master 2>$null
}
catch {
    Write-Host "   (No existing master branch to delete, continuing...)" -ForegroundColor DarkGray
}

# Create new master worktree tracking upstream
git worktree add -B master master --track upstream/master

# --- Setup STABLE ---
if ([string]::IsNullOrWhiteSpace($setupStable)) {
    if (-not [string]::IsNullOrWhiteSpace($env:SETUP_STABLE)) {
        $setupStable = $env:SETUP_STABLE
    }
    else {
        $setupStable = Read-Host "Do you want to setup the 'stable' worktree? (y/N)"
    }
}

if ($setupStable -match "^[yY]" -or $setupStable -eq "true" -or $setupStable -eq $true) {
    # Normalize for later use
    $setupStable = "y"
    Write-Host "ðŸŒ² Creating 'stable' worktree (based on upstream/$RefStable)..." -ForegroundColor Green
    git worktree add -B stable stable --track upstream/"$RefStable"
}

# 5. Pre-load Artifacts
# Determine correct flutter command based on OS for cross-platform compatibility
$flutterCmd = if ($IsWindows) { ".\bin\flutter.bat" } else { "./bin/flutter" }
if ($setupStable -match "^[yY]") {
    Write-Host "ðŸ› ï¸  Hydrating 'stable' artifacts..." -ForegroundColor Magenta
    Set-Location stable
    & $flutterCmd --version | Out-Null
    Set-Location ..
}

Write-Host "ðŸ› ï¸  Hydrating 'master' artifacts..." -ForegroundColor Magenta
Set-Location master
& $flutterCmd --version | Out-Null
Set-Location ..

# 6. Generate The Switcher Script
Write-Host "ðŸ”— Generating context switcher..." -ForegroundColor Cyan
$SwitchFile = Join-Path $RootPath "fswitch.ps1"

$PAYLOAD = "IyBTb3VyY2UgdGhpcyBmaWxlIGluIHlvdXIgUG93ZXJTaGVsbCBQcm9maWxlCiMgVXNhZ2U6IC4gIiRTd2l0Y2hGaWxlIgoKIyBSZXNldCByb290IHRvIGVuc3VyZSBubyBzdGFsZSB2YWx1ZXMKJGdsb2JhbDpGbHV0dGVyUmVwb1Jvb3QgPSAkbnVsbAoKaWYgKCRQU1NjcmlwdFJvb3QpIHsKICAgICRnbG9iYWw6Rmx1dHRlclJlcG9Sb290ID0gJFBTU2NyaXB0Um9vdAp9CmVsc2UgewogICAgJGdsb2JhbDpGbHV0dGVyUmVwb1Jvb3QgPSBHZXQtTG9jYXRpb24gfCBTZWxlY3QtT2JqZWN0IC1FeHBhbmRQcm9wZXJ0eSBQYXRoCn0KCmZ1bmN0aW9uIEdldC1GbHV0dGVyV29ya3RyZWVzIHsKICAgIGlmIChUZXN0LVBhdGggIiRnbG9iYWw6Rmx1dHRlclJlcG9Sb290IiAtUGF0aFR5cGUgQ29udGFpbmVyKSB7CiAgICAgICAgJGdpdEFyZ3MgPSBAKCItQyIsICIkZ2xvYmFsOkZsdXR0ZXJSZXBvUm9vdCIsICJ3b3JrdHJlZSIsICJsaXN0IikKICAgICAgICB0cnkgewogICAgICAgICAgICAkb3V0cHV0ID0gJiBnaXQgJGdpdEFyZ3MgMj4kbnVsbAogICAgICAgICAgICBpZiAoJExBU1RFWElUQ09ERSAtZXEgMCkgewogICAgICAgICAgICAgICAgJG91dHB1dCB8IFdoZXJlLU9iamVjdCB7ICRfIC1ub3RtYXRjaCAiXChiYXJlXCkiIH0gfCBGb3JFYWNoLU9iamVjdCB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCRfIC1tYXRjaCAnXig/PHBhdGg+Lio/KVxzK1swLTlhLWZdK1xzKyg/PGV4dHJhPi4qKSQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRmdWxsUGF0aCA9ICRtYXRjaGVzWydwYXRoJ10KICAgICAgICAgICAgICAgICAgICAgICAgJGV4dHJhID0gJG1hdGNoZXNbJ2V4dHJhJ10KICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgQ2FsY3VsYXRlIERpck5hbWUgKFJlbGF0aXZlIHBhdGggb3IgTGVhZiBuYW1lKQogICAgICAgICAgICAgICAgICAgICAgICAkZGlyTmFtZSA9ICIiCiAgICAgICAgICAgICAgICAgICAgICAgICMgTm9ybWFsaXplIGZvciBjb21wYXJpc29uIChHaXQgb3V0cHV0IHVzdWFsbHkgaGFzIGZvcndhcmQgc2xhc2hlcyBvciBtYXRjaGVzIHN5c3RlbSkKICAgICAgICAgICAgICAgICAgICAgICAgIyBXZSB1c2Ugc2ltcGxlIHN0cmluZyBvcGVyYXRpb25zLiAKICAgICAgICAgICAgICAgICAgICAgICAgIyBBc3N1bWluZyAkZ2xvYmFsOkZsdXR0ZXJSZXBvUm9vdCBpcyBub3JtYWxpemVkIHRvIHN5c3RlbSBzZXBhcmF0b3JzIGJ5IFBTU2NyaXB0Um9vdCBsb2dpYyB1c3VhbGx5PwogICAgICAgICAgICAgICAgICAgICAgICAjIEJ1dCBnaXQgb3V0cHV0IG1pZ2h0IHVzZSBmb3J3YXJkIHNsYXNoZXMgZXZlbiBvbiBXaW5kb3dzLgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgJG5vcm1GdWxsID0gJGZ1bGxQYXRoIC1yZXBsYWNlICdbXFwvXScsIFtTeXN0ZW0uSU8uUGF0aF06OkRpcmVjdG9yeVNlcGFyYXRvckNoYXIKICAgICAgICAgICAgICAgICAgICAgICAgJG5vcm1Sb290ID0gJGdsb2JhbDpGbHV0dGVyUmVwb1Jvb3QgLXJlcGxhY2UgJ1tcXC9dJywgW1N5c3RlbS5JTy5QYXRoXTo6RGlyZWN0b3J5U2VwYXJhdG9yQ2hhcgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRub3JtRnVsbCAtZXEgJG5vcm1Sb290KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZGlyTmFtZSA9IFNwbGl0LVBhdGggLUxlYWYgJG5vcm1GdWxsCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZWlmICgkbm9ybUZ1bGwuU3RhcnRzV2l0aCgkbm9ybVJvb3QsIFtTeXN0ZW0uU3RyaW5nQ29tcGFyaXNvbl06Ok9yZGluYWxJZ25vcmVDYXNlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBSZW1vdmUgcm9vdCBwcmVmaXggYW5kIGxlYWRpbmcgc2xhc2gKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRkaXJOYW1lID0gJG5vcm1GdWxsLlN1YnN0cmluZygkbm9ybVJvb3QuTGVuZ3RoKS5UcmltU3RhcnQoW1N5c3RlbS5JTy5QYXRoXTo6RGlyZWN0b3J5U2VwYXJhdG9yQ2hhcikKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgRmFsbGJhY2sKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRkaXJOYW1lID0gU3BsaXQtUGF0aCAtTGVhZiAkbm9ybUZ1bGwKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgJGJyYW5jaCA9ICIiCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkZXh0cmEgLW1hdGNoICdcWyg/PGJyPi4qPylcXScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRicmFuY2ggPSAkbWF0Y2hlc1snYnInXQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBbUFNDdXN0b21PYmplY3RdQHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFBhdGggICAgPSAkbm9ybUZ1bGwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIERpck5hbWUgPSAkZGlyTmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgQnJhbmNoICA9ICRicmFuY2gKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjYXRjaCB7CiAgICAgICAgICAgIFdyaXRlLVdhcm5pbmcgIkNvdWxkIG5vdCBleGVjdXRlICdnaXQgd29ya3RyZWUgbGlzdCcuIEVuc3VyZSBnaXQgaXMgaW5zdGFsbGVkIGFuZCBpbiB5b3VyIFBBVEguIgogICAgICAgIH0KICAgIH0KfQoKZnVuY3Rpb24gZnN3aXRjaCB7CiAgICBwYXJhbSgKICAgICAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeSA9ICR0cnVlLCBQb3NpdGlvbiA9IDApXQogICAgICAgIFtBcmd1bWVudENvbXBsZXRlcih7CiAgICAgICAgICAgICAgICBwYXJhbSgkY29tbWFuZE5hbWUsICRwYXJhbWV0ZXJOYW1lLCAkd29yZFRvQ29tcGxldGUsICRjb21tYW5kQXN0LCAkZmFrZUJvdW5kUGFyYW1ldGVycykKICAgICAgICAgICAgICAgICR3b3JrdHJlZXMgPSBHZXQtRmx1dHRlcldvcmt0cmVlcwogICAgICAgICAgICAgICAgJHRhcmdldHMgPSBAKCkKICAgICAgICAgICAgICAgIGlmICgkd29ya3RyZWVzKSB7CiAgICAgICAgICAgICAgICAgICAgJHRhcmdldHMgKz0gJHdvcmt0cmVlcy5EaXJOYW1lCiAgICAgICAgICAgICAgICAgICAgJHRhcmdldHMgKz0gJHdvcmt0cmVlcy5CcmFuY2gKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICR0YXJnZXRzIHwgV2hlcmUtT2JqZWN0IHsgJF8gLWxpa2UgIiR3b3JkVG9Db21wbGV0ZSoiIH0gfCBTb3J0LU9iamVjdCAtVW5pcXVlIHwgRm9yRWFjaC1PYmplY3QgewogICAgICAgICAgICAgICAgICAgIFtTeXN0ZW0uTWFuYWdlbWVudC5BdXRvbWF0aW9uLkNvbXBsZXRpb25SZXN1bHRdOjpuZXcoJF8sICRfLCAnUGFyYW1ldGVyVmFsdWUnLCAkXykKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSldCiAgICAgICAgW3N0cmluZ10kVGFyZ2V0CiAgICApCgogICAgJHdvcmt0cmVlcyA9IEdldC1GbHV0dGVyV29ya3RyZWVzCiAgICAkcmVzb2x2ZWRXdCA9ICRudWxsCgogICAgaWYgKCR3b3JrdHJlZXMpIHsKICAgICAgICBmb3JlYWNoICgkd3QgaW4gJHdvcmt0cmVlcykgewogICAgICAgICAgICBpZiAoJFRhcmdldCAtZXEgJHd0LkRpck5hbWUgLW9yICgkd3QuQnJhbmNoIC1hbmQgJFRhcmdldCAtZXEgJHd0LkJyYW5jaCkpIHsKICAgICAgICAgICAgICAgICRyZXNvbHZlZFd0ID0gJHd0CiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGlmICgkbnVsbCAtZXEgJHJlc29sdmVkV3QpIHsKICAgICAgICBXcml0ZS1FcnJvciAi4p2MIEludmFsaWQgdGFyZ2V0OiAnJFRhcmdldCciCiAgICAgICAgV3JpdGUtSG9zdCAiICAgQXZhaWxhYmxlIGNvbnRleHRzOiIKICAgICAgICBpZiAoJHdvcmt0cmVlcykgewogICAgICAgICAgICBmb3JlYWNoICgkd3QgaW4gJHdvcmt0cmVlcykgewogICAgICAgICAgICAgICAgJGJJbmZvID0gaWYgKCR3dC5CcmFuY2gpIHsgJHd0LkJyYW5jaCB9IGVsc2UgeyAiZGV0YWNoZWQiIH0KICAgICAgICAgICAgICAgIFdyaXRlLUhvc3QgIiAgIC0gJCgkd3QuRGlyTmFtZSkgKCRiSW5mbykiCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIFdyaXRlLUhvc3QgIiAgIChObyB3b3JrdHJlZXMgZm91bmQuIENoZWNrIGlmIGdpdCBpcyBpbnN0YWxsZWQgYW5kICckZ2xvYmFsOkZsdXR0ZXJSZXBvUm9vdCcgaXMgYSB2YWxpZCByZXBvLikiCiAgICAgICAgfQogICAgICAgIHJldHVybgogICAgfQoKICAgICMgMS4gQ2xlYW4gUGF0aAogICAgJHNlcENoYXIgPSBbU3lzdGVtLklPLlBhdGhdOjpQYXRoU2VwYXJhdG9yCiAgICBpZiAoJG51bGwgLW5lICRlbnY6UEFUSCkgewogICAgICAgICRjdXJyZW50UGF0aCA9ICRlbnY6UEFUSC5TcGxpdCgkc2VwQ2hhciwgW1N5c3RlbS5TdHJpbmdTcGxpdE9wdGlvbnNdOjpSZW1vdmVFbXB0eUVudHJpZXMpCiAgICB9CiAgICBlbHNlIHsKICAgICAgICAkY3VycmVudFBhdGggPSBAKCkKICAgIH0KCiAgICAkY2xlYW5QYXRoID0gQCgkY3VycmVudFBhdGgpIHwgV2hlcmUtT2JqZWN0IHsKICAgICAgICAkcGF0aCA9ICRfCiAgICAgICAgaWYgKFtzdHJpbmddOjpJc051bGxPcldoaXRlU3BhY2UoJHBhdGgpKSB7CiAgICAgICAgICAgIHJldHVybiAkZmFsc2UKICAgICAgICB9CgogICAgICAgIGlmICgtbm90IFtzdHJpbmddOjpJc051bGxPckVtcHR5KCRnbG9iYWw6Rmx1dHRlclJlcG9Sb290KSkgewogICAgICAgICAgICAkbm9ybVBhdGggPSAkcGF0aC5UcmltRW5kKFtTeXN0ZW0uSU8uUGF0aF06OkRpcmVjdG9yeVNlcGFyYXRvckNoYXIsIFtTeXN0ZW0uSU8uUGF0aF06OkFsdERpcmVjdG9yeVNlcGFyYXRvckNoYXIpCiAgICAgICAgICAgICRub3JtUm9vdCA9ICRnbG9iYWw6Rmx1dHRlclJlcG9Sb290LlRyaW1FbmQoW1N5c3RlbS5JTy5QYXRoXTo6RGlyZWN0b3J5U2VwYXJhdG9yQ2hhciwgW1N5c3RlbS5JTy5QYXRoXTo6QWx0RGlyZWN0b3J5U2VwYXJhdG9yQ2hhcikKICAgICAgICAgICAgaWYgKCRub3JtUGF0aC5TdGFydHNXaXRoKCRub3JtUm9vdCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkZmFsc2UKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gJHRydWUKICAgIH0KCiAgICAjIDIuIFVwZGF0ZSBQYXRoCiAgICAjIFVzZSB0aGUgRlVMTCBQQVRIIGZyb20gdGhlIHJlc29sdmVkIHdvcmt0cmVlCiAgICAkbmV3QmluID0gSm9pbi1QYXRoICRyZXNvbHZlZFd0LlBhdGggImJpbiIKICAgICRldEJpbiA9IEpvaW4tUGF0aCAkcmVzb2x2ZWRXdC5QYXRoICJlbmdpbmVcc3JjXGZsdXR0ZXJcYmluIgoKICAgIGlmICgtbm90IChUZXN0LVBhdGggJG5ld0JpbiAtUGF0aFR5cGUgQ29udGFpbmVyKSkgewogICAgICAgIFdyaXRlLUVycm9yICLinYwgRXJyb3I6IEZsdXR0ZXIgYmluIGRpcmVjdG9yeSBub3QgZm91bmQgYXQgJyRuZXdCaW4nIgogICAgICAgIHJldHVybgogICAgfQoKICAgIGlmICgtbm90ICRJc1dpbmRvd3MpIHsKICAgICAgICAkZmx1dHRlckJpbiA9IEpvaW4tUGF0aCAkbmV3QmluICJmbHV0dGVyIgogICAgICAgIGlmIChUZXN0LVBhdGggJGZsdXR0ZXJCaW4pIHsKICAgICAgICAgICAgaWYgKEdldC1Db21tYW5kIGNobW9kIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlKSB7CiAgICAgICAgICAgICAgICBjaG1vZCAreCAiJGZsdXR0ZXJCaW4iIDI+JG51bGwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAkcGF0aHNUb0FkZCA9IEAoJG5ld0JpbikKICAgIGlmIChUZXN0LVBhdGggJGV0QmluIC1QYXRoVHlwZSBDb250YWluZXIpIHsKICAgICAgICAkcGF0aHNUb0FkZCArPSAkZXRCaW4KICAgIH0KCiAgICBpZiAoJGNsZWFuUGF0aC5Db3VudCAtZ3QgMCkgewogICAgICAgICRlbnY6UEFUSCA9ICgkcGF0aHNUb0FkZCAtam9pbiAkc2VwQ2hhcikgKyAkc2VwQ2hhciArICgkY2xlYW5QYXRoIC1qb2luICRzZXBDaGFyKQogICAgfQogICAgZWxzZSB7CiAgICAgICAgJGVudjpQQVRIID0gKCRwYXRoc1RvQWRkIC1qb2luICRzZXBDaGFyKQogICAgfQoKICAgICMgMy4gVmVyaWZ5CiAgICBXcml0ZS1Ib3N0ICLinIUgU3dpdGNoZWQgdG8gRmx1dHRlciAkKCRyZXNvbHZlZFd0LkRpck5hbWUpIiAtRm9yZWdyb3VuZENvbG9yIEdyZWVuCgogICAgJGZsdXR0ZXJQYXRoID0gKEdldC1Db21tYW5kIGZsdXR0ZXIgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUpLlNvdXJjZQogICAgJGRhcnRQYXRoID0gKEdldC1Db21tYW5kIGRhcnQgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUpLlNvdXJjZQoKICAgIFdyaXRlLUhvc3QgIiAgIEZsdXR0ZXI6ICRmbHV0dGVyUGF0aCIKICAgIFdyaXRlLUhvc3QgIiAgIERhcnQ6ICAgICRkYXJ0UGF0aCIKfQoKZnVuY3Rpb24gZmNkIHsKICAgICRmbHV0dGVyUGF0aCA9IEdldC1Db21tYW5kIGZsdXR0ZXIgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUKICAgIGlmICgkbnVsbCAtZXEgJGZsdXR0ZXJQYXRoKSB7CiAgICAgICAgV3JpdGUtRXJyb3IgIuKdjCBGbHV0dGVyIGNvbW1hbmQgbm90IGZvdW5kLiBSdW4gJ2Zzd2l0Y2ggPHRhcmdldD4nIGZpcnN0LiIKICAgICAgICByZXR1cm4KICAgIH0KCiAgICAjIGZsdXR0ZXJQYXRoLlNvdXJjZSB3aWxsIGJlIHNvbWV0aGluZyBsaWtlIC4uLlxmbHV0dGVyX3JlcG9cbWFzdGVyXGJpblxmbHV0dGVyLmJhdAogICAgJGJpbkRpciA9IFNwbGl0LVBhdGggJGZsdXR0ZXJQYXRoLlNvdXJjZSAtUGFyZW50CgogICAgIyBXZSBleHBlY3QgJ2JpbicgdG8gYmUgdGhlIHBhcmVudC4gR28gb25lIGxldmVsIHVwLgogICAgaWYgKChTcGxpdC1QYXRoICRiaW5EaXIgLUxlYWYpIC1lcSAiYmluIikgewogICAgICAgICRyb290RGlyID0gU3BsaXQtUGF0aCAkYmluRGlyIC1QYXJlbnQKICAgICAgICBTZXQtTG9jYXRpb24gJHJvb3REaXIKICAgIH0KICAgIGVsc2UgewogICAgICAgICMgRmFsbGJhY2sgaWYgc3RydWN0dXJlIGlzIHdlaXJkLCB0aG91Z2ggZnN3aXRjaCBlbmZvcmNlcyBiaW4KICAgICAgICBTZXQtTG9jYXRpb24gJGJpbkRpcgogICAgfQp9CgpTZXQtQWxpYXMgLU5hbWUgZnJvb3QgLVZhbHVlIGZjZAoKIyBPcHRpb25hbDogRGVmYXVsdCB0byBhIHZlcnNpb24gb24gbG9hZCBpZiBubyBmbHV0dGVyIGlzIGZvdW5kCmlmICgtbm90IChHZXQtQ29tbWFuZCBmbHV0dGVyIC1FcnJvckFjdGlvbiBTaWxlbnRseUNvbnRpbnVlKSkgewogICAgIyBTd2l0Y2ggdG8gbWFzdGVyCiAgICBmc3dpdGNoIG1hc3Rlcgp9Cgo="
[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($PAYLOAD)) | Set-Content -Path $SwitchFile -Encoding UTF8

Write-Host ""
Write-Host "âœ… Setup Complete!" -ForegroundColor Green
Write-Host "------------------------------------------------------"
Write-Host "ðŸ“‚ Root:      $RootPath"
Write-Host "ðŸ‘‰ To enable the switcher, add this to your PowerShell Profile:"
Write-Host "   . '$SwitchFile'"
Write-Host ""
Write-Host "Usage:"
Write-Host "   PS> fswitch master   -> Activates master branch"
Write-Host "   PS> fswitch stable   -> Activates stable branch"
Write-Host ""
Write-Host "Want to create a new worktree?"
Write-Host "   PS> git worktree add my_feature"
Write-Host "------------------------------------------------------"

